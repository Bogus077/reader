# Reader Backend

Бэкенд приложения Reader на Express и TypeScript.

## Запуск проекта локально

1. Установите зависимости:

   ```
   pnpm i
   ```

2. Запустите базу данных PostgreSQL через Docker:

   ```
   docker compose -f docker/docker-compose.yml up -d postgres
   ```

3. Создайте файл .env из .env.example:

   ```
   cp .env.example .env
   ```

   Убедитесь, что параметры подключения к базе данных в .env соответствуют настройкам в docker-compose.yml.

4. Примените миграции для создания таблиц в базе данных:

   ```
   pnpm migrate
   ```

5. Заполните базу данных начальными данными:

   ```
   pnpm seed
   ```

6. Запустите сервер в режиме разработки:
   ```
   pnpm dev
   ```
   При успешном подключении к базе данных вы увидите сообщение "DB connected".

Сервер будет доступен по адресу http://localhost:8080

## Запуск в Docker

Приложение можно запустить полностью в Docker, включая API и базу данных:

1. Создайте файл .env из .env.example:

   ```
   cp .env.example .env
   ```

   При необходимости отредактируйте переменные в .env файле. Докер автоматически использует эти переменные.

2. Соберите и запустите контейнеры:

   ```
   docker compose -f docker/docker-compose.yml up -d --build
   ```

   Все переменные из .env файла будут автоматически подставлены в docker-compose.yml. Если какие-то переменные не заданы, будут использованы значения по умолчанию.

3. Примените миграции внутри контейнера:

   ```
   docker compose -f docker/docker-compose.yml exec api npx sequelize db:migrate
   ```

4. Заполните базу данных начальными данными:
   ```
   docker compose -f docker/docker-compose.yml exec api npx sequelize db:seed:all
   ```

После запуска API будет доступен по адресу http://localhost:8080 (или по порту, указанному в переменной PORT).

## База данных

### Структура базы данных

База данных содержит следующие таблицы:

1. **users** - пользователи системы

   - Роли: mentor, student
   - Начальные данные: один ментор и один студент

2. **books** - книги для чтения

   - Содержит информацию о книгах: название, автор, категория, сложность (1-5)
   - Начальные данные: две книги разных категорий и уровней сложности

3. **student_books** - назначение книг студентам

   - Связывает студентов и книги
   - Содержит статус чтения (active, finished, paused), даты начала/окончания, режим прогресса
   - Начальные данные: одна активная запись для студента

4. **assignments** - задания по чтению книг

   - Связаны с назначенными книгами (student_books)
   - Содержит дату, время дедлайна, целевые показатели (процент, страница, глава, параграф)
   - Статус задания: pending, submitted, missed, graded
   - Начальные данные: пять заданий на ближайшие будние дни

5. **recaps** - оценки за день

   - Связаны с заданиями (assignments) связью 1:1
   - Содержит оценку ментора (1-5) и комментарий
   - Начальные данные: нет

6. **streaks** - серии выполнения заданий
   - Связаны со студентами (users) связью 1:1
   - Содержит текущую длину серии, лучшую длину серии и дату последнего обновления
   - Начальные данные: нулевая запись для студента

### Запуск PostgreSQL в Docker

Для запуска базы данных PostgreSQL используйте Docker:

```
docker compose -f docker/docker-compose.yml up -d
```

### Остановка базы данных

```
docker compose -f docker/docker-compose.yml down
```

## Аутентификация

Приложение использует JWT-токены для аутентификации и поддерживает вход через Telegram WebApp.

### Переменные окружения

Для работы аутентификации необходимо добавить следующие переменные в файл `.env`:

```
JWT_SECRET=your_jwt_secret_key
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
```

### API Endpoints

#### POST /auth/telegram

Аутентификация через Telegram WebApp.

**Заголовки запроса:**

- `X-Telegram-Init-Data`: Сырые данные initData из Telegram WebApp

**Пример успешного ответа:**

```json
{
  "ok": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "role": "student",
    "name": "Иван Иванов",
    "tz": "Europe/Samara"
  }
}
```

**Коды ответа:**

- 200: Успешная аутентификация
- 400: Отсутствует заголовок X-Telegram-Init-Data
- 401: Неверная подпись или просроченные данные
- 500: Внутренняя ошибка сервера

#### GET /me

Получение данных текущего пользователя.

**Заголовки запроса:**

- `Authorization`: Bearer <token>

**Пример успешного ответа:**

```json
{
  "id": 1,
  "role": "student",
  "name": "Иван Иванов",
  "tz": "Europe/Samara"
}
```

**Коды ответа:**

- 200: Успешный запрос
- 401: Отсутствует или неверный токен

### Эндпоинты для менторов

Все эндпоинты требуют заголовок `Authorization: Bearer <token>` и роль пользователя `mentor`.

#### GET /mentor/students

Получение списка всех студентов с информацией о прогрессе.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "students": [
    {
      "id": 2,
      "name": "Иван Иванов",
      "activeBook": {
        "id": 1,
        "title": "Война и мир",
        "cover_url": "https://example.com/war-and-peace.jpg"
      },
      "progressPercent": 45,
      "todayStatus": "submitted",
      "lastRating": 4,
      "currentStreak": 3
    },
    {
      "id": 3,
      "name": "Петр Петров",
      "activeBook": null,
      "progressPercent": 0,
      "todayStatus": null,
      "lastRating": null
    }
  ]
}
```

**Описание полей:**

- `activeBook` - информация о текущей активной книге или null
- `progressPercent` - прогресс выполнения заданий по активной книге (0-100)
- `todayStatus` - статус задания на сегодня или null
- `lastRating` - последняя оценка ментора (1-5) или null
- `currentStreak` - текущая серия выполненных заданий (вычисляется динамически)

**Коды ответа:**

- 200: Успешный запрос
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 500: Внутренняя ошибка сервера

#### GET /mentor/students/:id

Получение детальной информации о конкретном студенте.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "student": { "id": 2, "name": "Иван Иванов", "tz": "Europe/Samara" },
  "activeBook": {
    "id": 1,
    "title": "Война и мир",
    "cover_url": "https://example.com/war-and-peace.jpg",
    "author": "Л.Н. Толстой"
  },
  "today": {
    "assignment": {
      "id": 10,
      "date": "2025-08-21",
      "deadline_time": "18:00",
      "status": "pending",
      "target": {
        "percent": 3,
        "page": null,
        "chapter": null,
        "last_paragraph": null
      }
    }
  },
  "strips": [
    {
      "date": "2025-08-19",
      "status": "done",
      "rating": 4,
      "submittedAt": "2025-08-19T15:30:00.000Z"
    },
    { "date": "2025-08-20", "status": "missed" },
    { "date": "2025-08-21", "status": "current" },
    { "date": "2025-08-22", "status": "future" }
  ],
  "recentRatings": [
    { "date": "2025-08-19", "rating": 4, "comment": "Хорошая работа!" },
    { "date": "2025-08-17", "rating": 5, "comment": "Отлично!" }
  ],
  "currentStreak": 3
}
```

**Описание полей:**

- `student` - информация о студенте (id, имя, временная зона)
- `activeBook` - информация о текущей активной книге или null
- `today.assignment` - задание на сегодня или ближайшее будущее, или null
- `strips` - массив дневных сегментов с информацией о статусе, рейтинге и времени отправки
- `recentRatings` - последние оценки ментора с комментариями
- `currentStreak` - текущая серия выполненных заданий (вычисляется динамически)

**Коды ответа:**

- 200: Успешный запрос
- 400: Неверный ID студента
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 404: Студент не найден
- 500: Внутренняя ошибка сервера

#### POST /mentor/assignments/generate

Генерация заданий для студента на указанный период. Автоматически пропускает выходные дни (суббота и воскресенье) и избегает создания дубликатов заданий.

**Тело запроса:**

```json
{
  "student_book_id": 1,
  "mode": "percent",
  "dailyTarget": 3,
  "deadline_time": "20:00",
  "startDate": "2025-08-25",
  "endDate": "2025-09-05"
}
```

**Описание полей запроса:**

- `student_book_id` - ID книги студента
- `mode` - режим цели: "percent" или "page"
- `dailyTarget` - ежедневная цель (проценты или страницы)
- `deadline_time` - время дедлайна в формате "HH:MM"
- `startDate` - дата начала периода в формате "YYYY-MM-DD"
- `endDate` - дата окончания периода в формате "YYYY-MM-DD"

**Пример успешного ответа:**

```json
{
  "ok": true,
  "created": 8,
  "skippedExisting": 2
}
```

**Описание полей ответа:**

- `created` - количество созданных заданий
- `skippedExisting` - количество пропущенных заданий (уже существующих)

**Коды ответа:**

- 200: Успешный запрос
- 400: Ошибка валидации (недостающие поля, неверный формат дат, startDate > endDate)
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 404: Книга студента не найдена
- 500: Внутренняя ошибка сервера

#### PATCH /mentor/assignments/:id

Изменение параметров задания. Разрешено только для заданий в статусе 'pending' или 'submitted'.

**Тело запроса (все поля опциональны):**

```json
{
  "deadline_time": "20:00",
  "target_percent": 5,
  "target_page": null,
  "target_chapter": "3",
  "target_last_paragraph": "..."
}
```

**Описание полей запроса:**

- `deadline_time` - время дедлайна в формате "HH:MM"
- `target_percent` - целевой процент прогресса или null
- `target_page` - целевая страница или null
- `target_chapter` - целевая глава или null
- `target_last_paragraph` - последний параграф или null

**Пример успешного ответа:**

```json
{
  "ok": true
}
```

**Коды ответа:**

- 200: Успешное обновление
- 400: Неверный ID задания
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 404: Задание не найдено
- 409: Нельзя изменить задание в текущем статусе
- 500: Внутренняя ошибка сервера

#### POST /mentor/assignments/:id/grade

Оценка задания ментором. Устанавливает статус задания 'graded' и обновляет стрик студента.

**Тело запроса:**

```json
{
  "mentor_rating": 4,
  "mentor_comment": "Хорошая работа!"
}
```

**Описание полей запроса:**

- `mentor_rating` - оценка ментора от 1 до 5 (обязательное поле)
- `mentor_comment` - комментарий ментора (опциональное поле)

**Пример успешного ответа:**

```json
{
  "ok": true
}
```

**Логика обновления стрика:**

- Если у студента нет стрика → current_len=1, best_len=1, last_update_date=дата задания
- Если дата задания совпадает со следующим рабочим днём после последнего обновления → current_len++
- Иначе → current_len=1
- best_len = max(best_len, current_len), last_update_date=дата задания

**Коды ответа:**

- 200: Успешное обновление
- 400: Неверный ID задания или неверный рейтинг
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 404: Задание или книга студента не найдены
- 500: Внутренняя ошибка сервера

### Эндпоинты для работы с книгами

Все эндпоинты требуют заголовок `Authorization: Bearer <token>`.

#### GET /books/available

Получение списка всех доступных книг. Доступен для любой роли пользователя.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "books": [
    {
      "id": 1,
      "title": "Война и мир",
      "author": "Лев Толстой",
      "category": "Классика",
      "difficulty": 3,
      "cover_url": "https://example.com/war-and-peace.jpg",
      "source_url": "https://example.com/books/war-and-peace"
    }
  ]
}
```

**Коды ответа:**

- 200: Успешный запрос
- 401: Отсутствует или неверный токен
- 500: Внутренняя ошибка сервера

#### POST /mentor/student-books/assign

Назначение книги студенту. Завершает предыдущую активную книгу ученика (если есть) и создает новую со статусом 'active'. Доступен только для менторов.

**Тело запроса:**

```json
{
  "student_id": 1,
  "book_id": 2,
  "progress_mode": "percent",
  "start_date": "2025-08-25"
}
```

**Описание полей запроса:**

- `student_id` - ID студента
- `book_id` - ID книги
- `progress_mode` - режим прогресса: "percent" или "page"
- `start_date` - дата начала в формате "YYYY-MM-DD"

**Пример успешного ответа:**

```json
{
  "ok": true,
  "student_book_id": 5
}
```

**Коды ответа:**

- 200: Успешное назначение
- 400: Ошибка валидации (недостающие поля, неверный формат даты)
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 404: Студент или книга не найдены
- 500: Внутренняя ошибка сервера

#### PATCH /mentor/student-books/:id/status

Изменение статуса книги студента. Если статус устанавливается в 'finished' и end_date пуст, автоматически заполняется текущей датой. Доступен только для менторов.

**Тело запроса:**

```json
{
  "status": "finished",
  "date": "2025-09-15"
}
```

**Описание полей запроса:**

- `status` - новый статус книги: "paused", "active" или "finished"
- `date` - дата в формате "YYYY-MM-DD" (опционально)

**Пример успешного ответа:**

```json
{
  "ok": true
}
```

**Коды ответа:**

- 200: Успешное обновление
- 400: Неверный ID книги студента или неверный статус
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не ментор)
- 404: Книга студента не найдена
- 500: Внутренняя ошибка сервера

### Эндпоинты для студентов

Все эндпоинты требуют заголовок `Authorization: Bearer <token>` и роль пользователя `student`.

#### GET /student/current-book

Получение текущей активной книги студента и прогресса.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "book": {
    "id": 1,
    "title": "Война и мир",
    "author": "Лев Толстой",
    "cover_url": "https://example.com/war-and-peace.jpg"
  },
  "progress": {
    "percent": 45,
    "daysDone": 9,
    "daysTotal": 20
  },
  "currentStreak": 3,
  "bestStreak": 5
}
```

**Коды ответа:**

- 200: Успешный запрос (даже если нет активной книги, тогда book: null, progress: null)
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не студент)
- 500: Внутренняя ошибка сервера

#### GET /student/progress

Получение прогресса студента, включая текущую и лучшую серию выполненных заданий, среднюю оценку и статистику по дням.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "currentStreak": 3,
  "bestStreak": 5,
  "avgRating": 4.2,
  "daysDone": 9,
  "daysTotal": 20
}
```

**Описание полей:**

- `currentStreak` - текущая серия выполненных заданий (вычисляется динамически)
- `bestStreak` - лучшая серия выполненных заданий (из таблицы streaks)
- `avgRating` - средняя оценка ментора по активной книге
- `daysDone` - количество выполненных заданий по активной книге
- `daysTotal` - общее количество заданий по активной книге

**Коды ответа:**

- 200: Успешный запрос
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не студент)
- 500: Внутренняя ошибка сервера

#### GET /student/assignment/today

Получение задания на сегодня или ближайшего будущего.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "assignment": {
    "id": 42,
    "date": "2025-08-21",
    "deadline_time": "23:59",
    "status": "pending",
    "target": {
      "percent": 15,
      "page": 42,
      "chapter": "Глава 3",
      "last_paragraph": "И тогда он понял..."
    }
  }
}
```

**Коды ответа:**

- 200: Успешный запрос (если нет заданий, assignment: null)
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не студент)
- 500: Внутренняя ошибка сервера

#### POST /student/assignment/:id/submit

Отметить задание как выполненное.

**Параметры URL:**

- `id`: ID задания

**Пример успешного ответа:**

```json
{
  "ok": true
}
```

**Коды ответа:**

- 200: Успешное выполнение задания
- 400: Неверный ID задания
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не студент)
- 404: Задание не найдено или нет активной книги
- 409: Задание не в статусе "pending"
- 500: Внутренняя ошибка сервера

#### GET /student/strips

Получение массива дневных сегментов по активной книге.

**Пример успешного ответа:**

```json
{
  "ok": true,
  "strips": [
    {
      "date": "2025-08-19",
      "status": "done",
      "rating": 4,
      "submittedAt": "2025-08-19T18:30:00.000Z"
    },
    {
      "date": "2025-08-20",
      "status": "missed"
    },
    {
      "date": "2025-08-21",
      "status": "current",
      "submittedAt": "2025-08-21T15:45:00.000Z"
    },
    {
      "date": "2025-08-22",
      "status": "future"
    }
  ]
}
```

**Описание статусов:**

- `done` - задание со статусом "graded" (если есть recap, то включает rating)
- `current` - ближайшее задание со статусом "pending" или "submitted" с датой ≥ сегодня
- `future` - все задания после current
- `missed` - прошедшие дни, не graded и не current

**Коды ответа:**

- 200: Успешный запрос (если нет активной книги, strips: [])
- 401: Отсутствует или неверный токен
- 403: Доступ запрещен (не студент)
- 500: Внутренняя ошибка сервера

### Просмотр логов

```
docker compose -f docker/docker-compose.yml logs
```

Для просмотра логов в режиме реального времени:

```
docker compose -f docker/docker-compose.yml logs -f
```

### Параметры подключения

- **Хост**: localhost
- **Порт**: 5432
- **База данных**: reading_app
- **Пользователь**: reading_user
- **Пароль**: change_me

## Валидация запросов и обработка ошибок

В приложении используется библиотека Zod для валидации запросов. Все роуты используют схемы валидации для проверки входных данных.

### Коды ошибок валидации

При ошибке валидации сервер возвращает ответ со статусом 400 Bad Request и детальной информацией об ошибках.

**Пример ответа при ошибке валидации:**

```json
{
  "ok": false,
  "error": "Validation error",
  "errors": {
    "body": {
      "student_book_id": {
        "_errors": ["Required"]
      },
      "mode": {
        "_errors": [
          "Invalid enum value. Expected 'percent' | 'page', received 'invalid'"
        ]
      }
    }
  }
}
```

### Общие коды ошибок

| Код | Описание                                                                       |
| --- | ------------------------------------------------------------------------------ |
| 200 | Успешный запрос                                                                |
| 400 | Ошибка валидации или неверные параметры запроса                                |
| 401 | Отсутствует или неверный токен аутентификации                                  |
| 403 | Доступ запрещен (недостаточно прав)                                            |
| 404 | Ресурс не найден                                                               |
| 409 | Конфликт состояний (например, попытка изменить задание в неподходящем статусе) |
| 500 | Внутренняя ошибка сервера                                                      |

## Правила отображения статусов заданий

В приложении используются следующие правила для отображения статусов заданий:

### Таблица правил определения визуального статуса

| Статус в БД | Дата задания | Дедлайн | Визуальный статус |
|------------|-------------|---------|------------------|
| `graded`   | любая       | любой   | `graded`         |
| `pending`  | < сегодня   | любой   | `missed`         |
| `pending`  | = сегодня   | прошел  | `missed`         |
| `pending`  | = сегодня   | не прошел | `pending`      |
| `pending`  | > сегодня   | любой   | `pending`        |
| `submitted`| < сегодня   | любой   | `missed`         |
| `submitted`| = сегодня   | прошел  | `missed`         |
| `submitted`| = сегодня   | не прошел | `submitted`    |
| `submitted`| > сегодня   | любой   | `submitted`      |

### Правила определения статуса в полосочках (strips)

| Условие                                                      | Статус в strips |
|--------------------------------------------------------------|----------------|
| Визуальный статус = `graded`                                 | `done`         |
| Ближайшее задание с датой ≥ сегодня и не прошедшим дедлайном | `current`      |
| Задание с датой > текущего задания                           | `future`       |
| Визуальный статус = `missed`                                 | `missed`       |
| Визуальный статус = `pending`/`submitted` (не current)        | `pending`/`submitted` |

**Важно:** 
1. Статус `missed` используется только для отображения и не изменяет фактический статус в базе данных. Статус в БД меняется только через явные действия (submit/grade).
2. Статус `current` в полосочках назначается только одному заданию - ближайшему с датой ≥ сегодня и не прошедшим дедлайном.
3. Визуальный статус определяется централизованно с помощью функции `resolveVisualStatus` в модуле `lib/time.ts`

## Dynamic streak

В приложении реализована система подсчета текущей серии выполненных заданий (streak) со следующими правилами:

1. Если сегодня не рабочий день (выходной), отсчет начинается с предыдущего рабочего дня.

2. Если задание на сегодня имеет статус `graded`, оно увеличивает серию на 1.

3. Если дедлайн задания на сегодня уже прошел, и задание не имеет статуса `graded`, серия сбрасывается до 0.

4. В серию засчитываются только непрерывные выполненные задания в рабочие дни (понедельник-пятница).

5. Правило динамического стрика: "после дедлайна сегодня — 0, иначе пропускаем сегодня и считаем со вчера назад".

Эта логика реализована в функции `computeCurrentStreak` и используется для отображения текущей серии выполненных заданий студента.

**Важно:** 
1. Дашборд ментора теперь показывает текущую длину серии выполненных заданий в реальном времени («как сейчас»), вычисляя её динамически в момент запроса без использования фоновых задач.
2. Лучший стрик (`best_len`) обновляется только в момент выставления оценки (`grade`), если текущий стрик превысил предыдущий лучший результат.

## Утилиты для работы с датами и временем

В приложении используются утилиты для работы с датами и временем, основанные на библиотеке dayjs с поддержкой временных зон.

### Константы форматов

- `DATE_FMT` - формат даты: `'YYYY-MM-DD'`
- `TIME_FMT` - формат времени: `'HH:mm'`

### Функции

#### nowInTz(tz: string)

Возвращает текущий момент времени в указанной временной зоне.

```typescript
// Пример
const now = nowInTz("Europe/Samara");
```

#### todayStr(tz: string)

Возвращает текущую дату в формате `YYYY-MM-DD` в указанной временной зоне.

```typescript
// Пример
const today = todayStr("Europe/Samara"); // '2025-08-21'
```

#### isPast(dateStr: string, tz: string)

Проверяет, является ли указанная дата прошедшей относительно текущей даты в указанной временной зоне.

```typescript
// Пример
const isDatePast = isPast("2025-08-20", "Europe/Samara"); // true, если сегодня 21 августа 2025
```

#### isSameDay(dateStr: string, tz: string)

Проверяет, является ли указанная дата текущим днем в указанной временной зоне.

```typescript
// Пример
const isToday = isSameDay("2025-08-21", "Europe/Samara"); // true, если сегодня 21 августа 2025
```

#### hasPassedDeadline(dateStr: string, deadlineHHmm: string, tz: string)

Проверяет, прошел ли указанный дедлайн (дата + время) относительно текущего момента в указанной временной зоне.

```typescript
// Пример
const deadlinePassed = hasPassedDeadline(
  "2025-08-21",
  "14:00",
  "Europe/Samara"
); // true, если сейчас после 14:00 21 августа 2025
```

## Работа с моделями

### Проверка связей между моделями

Для проверки связей между моделями можно использовать следующий код в REPL или скрипте:

```javascript
// Создайте файл scripts/test-associations.js
const { sequelize } = require("../src/lib/db");
const StudentBook = require("../src/modules/studentBooks/model").default;
const User = require("../src/modules/users/model").default;
const Book = require("../src/modules/books/model").default;

// Инициализация ассоциаций
User.hasMany(StudentBook, { foreignKey: "student_id" });
StudentBook.belongsTo(User, { foreignKey: "student_id" });

Book.hasMany(StudentBook, { foreignKey: "book_id" });
StudentBook.belongsTo(Book, { foreignKey: "book_id" });

async function testAssociations() {
  try {
    // Получаем все назначения книг с данными о студентах и книгах
    const studentBooks = await StudentBook.findAll({
      include: [User, Book],
    });

    console.log(JSON.stringify(studentBooks, null, 2));

    await sequelize.close();
  } catch (error) {
    console.error("Error testing associations:", error);
    await sequelize.close();
  }
}

testAssociations();
```

Запустите скрипт с помощью команды:

```
node scripts/test-associations.js
```
